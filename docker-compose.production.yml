version: '3.8'

# =============================================================================
# Production Docker Compose - API Security Gateway
#
# Usage:
#   docker compose -f docker-compose.production.yml --env-file .env.production up -d
#
# Services:
#   Core:       api-gateway, redis, gateway-ui
#   Monitoring: prometheus, grafana, alertmanager, loki, promtail
# =============================================================================

services:
  # ===========================================================================
  # Core Services
  # ===========================================================================

  # Redis - Distributed cache & rate limiting
  redis:
    image: redis:7-alpine
    container_name: prod-redis
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --save 300 100
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - gateway-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: always
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'

  # API Gateway - Main service (C++ binary)
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_TYPE=Release
    container_name: prod-api-gateway
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ISSUER=${JWT_ISSUER:-api-gateway}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-api-clients}
      - GATEWAY_PORT=${GATEWAY_PORT:-443}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=0
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - ADMIN_ENABLED=true
      - METRICS_ENABLED=true
      - CACHE_ENABLED=true
      - CACHE_DEFAULT_TTL=${CACHE_DEFAULT_TTL:-300}
      - WEBSOCKET_ENABLED=${WEBSOCKET_ENABLED:-true}
      - WEBSOCKET_MAX_CONNECTIONS=${WEBSOCKET_MAX_CONNECTIONS:-1000}
      - TLS_ENABLED=${TLS_ENABLED:-true}
    ports:
      - "443:443"
      - "8080:8080"
    volumes:
      - ./config/gateway.production.json:/app/config/gateway.json:ro
      - ./config/routes.production.json:/app/config/routes.json:ro
      - ./certs:/app/certs:ro
      - gateway-logs:/var/log/api-gateway
    networks:
      - gateway-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "--no-check-certificate", "https://localhost:443/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '2.0'
        reservations:
          memory: 128M
          cpus: '0.5'

  # Admin UI - Web management interface
  gateway-ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: prod-gateway-ui
    environment:
      - GATEWAY_URL=http://api-gateway:8080
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - NODE_ENV=production
      - NEXT_PUBLIC_APP_NAME=API Gateway Admin
      - NEXT_PUBLIC_REFRESH_INTERVAL=10000
    ports:
      - "127.0.0.1:3001:3000"
    networks:
      - gateway-network
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  # ===========================================================================
  # Monitoring Stack
  # ===========================================================================

  # Prometheus - Metrics collection & alerting
  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: prod-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--storage.tsdb.retention.size=10GB'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    ports:
      - "127.0.0.1:9090:9090"
    volumes:
      - ./monitoring/prometheus-production.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    networks:
      - gateway-network
    depends_on:
      - api-gateway
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M

  # Alertmanager - Alert routing & notifications
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: prod-alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://alertmanager:9093'
    ports:
      - "127.0.0.1:9093:9093"
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    networks:
      - gateway-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: always
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'

  # Grafana - Dashboards & visualization
  grafana:
    image: grafana/grafana:10.4.0
    container_name: prod-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true
      - GF_SECURITY_CONTENT_SECURITY_POLICY=true
      - GF_LOG_LEVEL=warn
      - GF_ALERTING_ENABLED=true
      - GF_UNIFIED_ALERTING_ENABLED=true
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - gateway-network
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # Loki - Log aggregation
  loki:
    image: grafana/loki:2.9.4
    container_name: prod-loki
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "127.0.0.1:3100:3100"
    volumes:
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    networks:
      - gateway-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 15s
      timeout: 5s
      retries: 3
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # Promtail - Log shipping agent
  promtail:
    image: grafana/promtail:2.9.4
    container_name: prod-promtail
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./monitoring/promtail.yml:/etc/promtail/config.yml:ro
      - gateway-logs:/var/log/api-gateway:ro
      - /var/log:/var/log/host:ro
    networks:
      - gateway-network
    depends_on:
      - loki
    restart: always
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'

networks:
  gateway-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  redis-data:
    driver: local
  gateway-logs:
    driver: local
  prometheus-data:
    driver: local
  alertmanager-data:
    driver: local
  grafana-data:
    driver: local
  loki-data:
    driver: local
